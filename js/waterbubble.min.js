(function(b){b.fn.waterbubble=function(e){var d=b.extend({},{radius:80,lineWidth:5,data:0,compareData:0.3,waterColor:"#abb4f7",innerWaterColor:"#f7b1ab",textColor:"rgba(0, 128, 0, 0.8)",warningTextColor:"rgba(255, 0, 0, 0.8)",font:"",wave:true,txt:undefined,animation:true,isgap:false,isSmallBubble:true,smallBubbleColor:"rgba(255,255,255,0.6)",smallRadius:20,textWidth:""},e);var c=this[0];d.lineWidth=d.lineWidth?d.lineWidth:d.radius/24;var f=new a(c,d);return this};function a(d,c){this.refresh(d,c)}a.prototype={refresh:function(d,c){d.getContext("2d").clearRect(0,0,d.width,d.height);this._init(d,c)},_init:function(f,e){var d=e.radius;var c=e.lineWidth;f.width=d*2+c;f.height=d*2+c;this._buildShape(f,e)},_buildShape:function(d,f){var p=d.getContext("2d");var l=f.lineWidth*2;if(f.isgap){var c=f.radius-l}else{var c=f.radius}var g=f.data;var h=f.lineWidth;var m=f.waterColor;var o=f.innerWaterColor;var n=f.textColor;var e=f.font;var i=f.wave;var k=f.radius+h/2;var j=f.radius+h/2;p.beginPath();p.arc(k,j,f.radius,0,Math.PI*2);p.lineWidth=h;p.strokeStyle=m;p.stroke();if(f.animation){this._animate(p,c,g,h,o,k,j,i)}else{this._fillWater(p,c,g,h,o,k,j,i)}this._drawText(p,n,e,f.radius,g,k,j,f.txt,f);return},_fillWater:function(t,c,e,f,q,n,l,i){t.beginPath();t.globalCompositeOperation="destination-over";var k=c*2*(1-e)+(l-c);var m=n-Math.sqrt((c)*(c)-(l-k)*(l-k));var p=n;var o=k;var j=2*p-m;var h=k;var s;if(e>0.9||e<0.1||!i){s=k}else{s=k-(p-m)/4}t.beginPath();t.moveTo(m,k);t.quadraticCurveTo((m+p)/2,s,p,o);t.quadraticCurveTo((p+j)/2,2*k-s,j,h);var g=-Math.asin((n-k)/c);var d=Math.PI-g;t.arc(n,l,c,g,d,false);t.fillStyle=q;t.fill()},_drawText:function(n,m,d,g,e,k,i,f,c){n.globalCompositeOperation="source-over";var o=d?d.replace(/\D+/g,""):0.4*g;n.font=d?d:"bold "+o+"px Microsoft Yahei";f=e*100+"%";var h=i+o/2;c.textWidth=n.measureText(f).width/2;var j=k-Math.floor(c.textWidth);if(e>c.compareData){m=c.warningTextColor}n.fillStyle=m;n.fillText(f,j,h);if(c.isSmallBubble){var l=c.textWidth+10;this._drawSmallBubble(n,k,i,l,c)}},_drawSmallBubble:function(d,c,g,f,e){d.beginPath();d.globalCompositeOperation="destination-over";d.arc(c,g,f,0,Math.PI*2);d.fillStyle=e.smallBubbleColor;d.fill()},_animate:function(o,c,f,g,m,l,k,h){var j={value:0};var i=window.requestAnimationFrame||window.msRequestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||function(p){setTimeout(p,16)};var n=this;var e=function(){if(j.value<f-0.01){j.value+=(f-j.value)/15;n._runing=true}else{n._runing=false}};var d=function(){n._fillWater(o,c,j.value,g,m,l,k,h);e();if(n._runing){i(d)}};d(o,c,j,g,m,l,k,h)}}}(jQuery));